<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>STARSEED - System Menu</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #000; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            user-select: none; -webkit-user-select: none; touch-action: none;
            font-family: 'Courier New', Courier, monospace;
        }
        #game-container {
            position: relative; width: 100vw; height: 100vh;
            max-width: 450px; max-height: 850px;
            display: flex; justify-content: center; align-items: center;
            background-color: #0d0d0d;
        }
        canvas {
            display: block; width: 100%; height: 100%;
            object-fit: contain; image-rendering: -moz-pixelated;
            image-rendering: pixelated; image-rendering: crisp-edges;
            transition: filter 0.1s linear; z-index: 1;
        }
        
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 10;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #28ff28; text-align: center;
        }
        .hidden { display: none !important; }
        
        input[type="text"] {
            background: #000; border: 2px solid #28ff28; color: #fff;
            padding: 12px; font-family: 'Courier New', Courier, monospace; font-size: 18px;
            text-align: center; width: 200px; margin-bottom: 20px; outline: none;
            text-transform: uppercase;
        }
        
        .ui-btn {
            background: #28ff28; color: #000; border: none; padding: 12px 24px;
            font-family: 'Courier New', Courier, monospace; font-size: 16px; font-weight: bold;
            cursor: pointer; text-transform: uppercase; margin: 10px;
        }
        .ui-btn:active { background: #fff; }

        /* --- MENU STYLES --- */
        .vessel-box {
            border: 2px solid #444; padding: 10px; cursor: pointer; position: relative;
            width: 50px; height: 60px; display: flex; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.5);
        }
        .vessel-box.active { border-color: #28ff28; box-shadow: 0 0 10px #28ff28; }
        .vessel-img { width: 40px; height: 50px; image-rendering: pixelated; }

        .lb-list {
            list-style: none; padding: 0; width: 240px; text-align: left; font-size: 18px; margin-bottom: 30px; color: #fff;
        }
        .lb-list li { display: flex; justify-content: space-between; border-bottom: 1px dashed #28ff28; padding: 8px 0; }
        .lb-list li span:first-child { color: #28ff28; font-weight: bold; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <div id="login-ui" class="overlay hidden">
        <h2 style="margin-bottom: 5px;">IDENTIFY VESSEL</h2>
        <p style="font-size: 12px; color: #aaa; margin-bottom: 20px;">ENTER ALIAS TO JOIN NETWORK</p>
        <input type="text" id="username-input" maxlength="10" placeholder="ALIAS">
        <button id="save-user-btn" class="ui-btn">SYNC IDENTITY</button>
    </div>

    <div id="main-menu-ui" class="overlay hidden">
        <h2 style="margin-bottom: 20px; letter-spacing: 2px;">SYSTEM MENU</h2>
        
        <h3 style="margin-bottom: 15px; color: #fff; font-size: 14px;">SELECT VESSEL</h3>
        <div style="display: flex; gap: 20px; margin-bottom: 40px;">
            <div id="v1-select" class="vessel-box active">
                <img src="bird.png" class="vessel-img" id="img-v1">
            </div>
            <div id="v2-select" class="vessel-box">
                <img src="bird2.png" class="vessel-img" id="img-v2" style="opacity: 0.3;">
                <div id="v2-lock" style="position: absolute; color: #666; font-size: 10px; font-weight: bold;">LOCKED</div>
            </div>
        </div>

        <button id="menu-lb-btn" class="ui-btn" style="width: 220px; margin-bottom: 15px;">HIGHEST SCORES</button>
        <button id="menu-mute-btn" class="ui-btn" style="width: 220px; margin-bottom: 25px; background: transparent; border: 2px solid #28ff28; color: #28ff28;">AUDIO: ON</button>
        <button id="close-menu-btn" class="ui-btn" style="width: 220px; background: #444; color: #fff;">RETURN TO DECK</button>
    </div>

    <div id="leaderboard-ui" class="overlay hidden">
        <h2 style="margin-bottom: 20px;">HIGHEST SCORES</h2>
        <ul id="leaderboard-list" class="lb-list">
            <li>LOADING NETWORK...</li>
        </ul>
        <button id="close-lb-btn" class="ui-btn">RETURN</button>
    </div>
</div>

<script>
// --- YOUR FIREBASE CONFIGURATION ---
const firebaseConfig = {
  apiKey: "AIzaSyBWLvgTFy7X6hcFRQdxWeiC8Dzt69m4V7E",
  authDomain: "starseed-game.firebaseapp.com",
  databaseURL: "https://starseed-game-default-rtdb.firebaseio.com",
  projectId: "starseed-game",
  storageBucket: "starseed-game.firebasestorage.app",
  messagingSenderId: "182800596",
  appId: "1:182800596:web:a59aa00afb1e99543d2b41"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const cvs = document.getElementById("gameCanvas");
const ctx = cvs.getContext("2d");

const gameWidth = 280; const gameHeight = 500;
const dpr = window.devicePixelRatio || 1;
cvs.width = gameWidth * dpr; cvs.height = gameHeight * dpr;
ctx.scale(dpr, dpr); ctx.imageSmoothingEnabled = false;

// DOM ELEMENTS
const loginUI = document.getElementById("login-ui");
const mainMenuUI = document.getElementById("main-menu-ui");
const lbUI = document.getElementById("leaderboard-ui");
const usernameInput = document.getElementById("username-input");
const saveUserBtn = document.getElementById("save-user-btn");
const closeLbBtn = document.getElementById("close-lb-btn");
const menuLbBtn = document.getElementById("menu-lb-btn");
const closeMenuBtn = document.getElementById("close-menu-btn");
const menuMuteBtn = document.getElementById("menu-mute-btn");
const lbList = document.getElementById("leaderboard-list");

const v1Select = document.getElementById("v1-select");
const v2Select = document.getElementById("v2-select");
const imgV2 = document.getElementById("img-v2");
const v2Lock = document.getElementById("v2-lock");

const bird1Img = new Image(); bird1Img.src = "bird.png"; 
const bird2Img = new Image(); bird2Img.src = "bird2.png"; 
const bgImg = new Image(); bgImg.src = "bg.png"; 

// AUDIO SETUP
const playlist = ["music.mp3", "music2.mp3", "music3.mp3", "music4.mp3"];
let currentTrackIndex = 0;
const music = new Audio(); music.crossOrigin = "anonymous"; music.src = playlist[currentTrackIndex]; music.loop = true;
const sound47 = new Audio(); sound47.src = "47.mp3";

let audioCtx, analyser, source, dataArray;
let isAudioInitialized = false; let bassPulse = 0; 
let isMuted = false;

function initAudio() {
    if (isAudioInitialized) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser(); analyser.fftSize = 256; 
    source = audioCtx.createMediaElementSource(music); source.connect(analyser); analyser.connect(audioCtx.destination);
    dataArray = new Uint8Array(analyser.frequencyBinCount); isAudioInitialized = true;
}

// VARIABLES
let username = localStorage.getItem("starseedUsername") || "";
let gamePlaying = false; let isDead = false; 
let isViewingUI = false; 
let frames = 0; let score = 0; let finalScore = 0;
let highScore = localStorage.getItem("starseedHighScore") || 0;
let bird2Unlocked = localStorage.getItem("bird2Unlocked") === "true";
let selectedBird = 1; let justUnlockedBird2 = false; let hueShift = 0;

// LIVE DATABASE SYNC
let globalLeaderboard = [];
db.ref('leaderboard').orderByChild('score').limitToLast(10).on('value', (snapshot) => {
    let data = [];
    snapshot.forEach((child) => { data.push({ name: child.key, score: child.val().score }); });
    globalLeaderboard = data.reverse(); 
    if (lbUI.classList.contains("hidden") === false) renderLeaderboard();
});

function renderLeaderboard() {
    lbList.innerHTML = "";
    if (globalLeaderboard.length === 0) { lbList.innerHTML = "<li>AWAITING FIRST SYNC...</li>"; return; }
    globalLeaderboard.forEach((entry, index) => {
        let li = document.createElement("li");
        li.innerHTML = `<span>${index + 1}. ${entry.name}</span> <span>${entry.score}</span>`;
        lbList.appendChild(li);
    });
}

function pushScoreToCloud() {
    if (username && finalScore > 0) {
        db.ref('leaderboard/' + username).once('value').then((snapshot) => {
            let currentCloudScore = snapshot.val() ? snapshot.val().score : 0;
            if (finalScore > currentCloudScore) { db.ref('leaderboard/' + username).set({ score: finalScore }); }
        });
    }
}

// --- UI EVENT LISTENERS ---
saveUserBtn.addEventListener("click", () => {
    let val = usernameInput.value.trim().toUpperCase();
    if (val.length > 0) {
        saveUserBtn.innerText = "CHECKING...";
        db.ref('leaderboard/' + val).once('value').then((snapshot) => {
            if (snapshot.exists()) {
                alert("ALIAS ALREADY IN USE. PLEASE CHOOSE ANOTHER."); saveUserBtn.innerText = "SYNC IDENTITY";
            } else {
                db.ref('leaderboard/' + val).set({ score: 0 });
                username = val; localStorage.setItem("starseedUsername", username);
                loginUI.classList.add("hidden"); 
            }
        }).catch((error) => { alert("NETWORK ERROR. TRY AGAIN."); saveUserBtn.innerText = "SYNC IDENTITY"; });
    }
});

function openMainMenu() {
    isViewingUI = true;
    updateVesselMenu();
    mainMenuUI.classList.remove("hidden");
}

closeMenuBtn.addEventListener("click", () => {
    mainMenuUI.classList.add("hidden");
    setTimeout(() => { isViewingUI = false; }, 100);
});

function updateVesselMenu() {
    if (selectedBird === 1) { v1Select.classList.add("active"); v2Select.classList.remove("active"); } 
    else { v2Select.classList.add("active"); v1Select.classList.remove("active"); }
    
    if (bird2Unlocked) { imgV2.style.opacity = "1"; v2Lock.style.display = "none"; } 
    else { imgV2.style.opacity = "0.3"; v2Lock.style.display = "block"; }
}

v1Select.addEventListener("click", () => { selectedBird = 1; updateVesselMenu(); });
v2Select.addEventListener("click", () => { if (bird2Unlocked) { selectedBird = 2; updateVesselMenu(); } });

menuMuteBtn.addEventListener("click", () => {
    isMuted = !isMuted;
    music.muted = isMuted; sound47.muted = isMuted;
    if (isMuted) {
        menuMuteBtn.innerText = "AUDIO: OFF"; menuMuteBtn.style.color = "#ff2828"; menuMuteBtn.style.borderColor = "#ff2828";
    } else {
        menuMuteBtn.innerText = "AUDIO: ON"; menuMuteBtn.style.color = "#28ff28"; menuMuteBtn.style.borderColor = "#28ff28";
    }
});

menuLbBtn.addEventListener("click", () => { mainMenuUI.classList.add("hidden"); lbUI.classList.remove("hidden"); renderLeaderboard(); });
closeLbBtn.addEventListener("click", () => { lbUI.classList.add("hidden"); mainMenuUI.classList.remove("hidden"); });

if (!username) { loginUI.classList.remove("hidden"); }

// --- GAME ENGINE ---
const starfield = {
    particles: [],
    init: function() {
        this.particles = [];
        for(let i = 0; i < 75; i++) { 
            let layer = Math.random(); let size, speed, opacity;
            if (layer < 0.6) { size = Math.random() * 0.5 + 0.5; speed = Math.random() * 0.2 + 0.1; opacity = 0.3; } 
            else if (layer < 0.9) { size = Math.random() * 1.0 + 1.0; speed = Math.random() * 0.5 + 0.5; opacity = 0.6; } 
            else { size = Math.random() * 1.5 + 1.5; speed = Math.random() * 1.2 + 1.0; opacity = 1.0; }
            this.particles.push({ x: Math.random() * gameWidth, y: Math.random() * gameHeight, size: size, speed: speed, baseOpacity: opacity, opacity: opacity });
        }
    },
    draw: function() {
        for(let p of this.particles) {
            p.opacity = p.baseOpacity + (Math.random() - 0.5) * 0.2;
            if(p.opacity < 0.1) p.opacity = 0.1;
            ctx.fillStyle = (Math.random() > 0.8) ? `rgba(40, 255, 40, ${p.opacity})` : `rgba(255, 255, 255, ${p.opacity})`;
            ctx.fillRect(Math.floor(p.x), Math.floor(p.y), p.size, p.size);
        }
    },
    update: function() {
        let globalSpeed = (gamePlaying || isDead) ? 2.5 : 0.3; 
        for(let p of this.particles) {
            p.x -= (p.speed * globalSpeed);
            if(p.x + p.size < 0) { p.x = gameWidth; p.y = Math.random() * gameHeight; }
        }
    }
};
starfield.init();

const bird = {
    x: 50, y: 220, w: 55, h: 65, speed: 0, gravity: 0.32, jump: 5.8,    
    draw: function() {
        ctx.save();
        let currentImg = (selectedBird === 1) ? bird1Img : bird2Img;
        if (bassPulse > 130 && gamePlaying) { ctx.shadowColor = "#28ff28"; ctx.shadowBlur = ((bassPulse - 130) / 125) * 25 + 5; } else { ctx.shadowBlur = 0; }
        if (currentImg.complete) { ctx.drawImage(currentImg, Math.floor(this.x), Math.floor(this.y), this.w, this.h); }
        ctx.restore();
    },
    update: function() {
        if (!gamePlaying && !isDead) { this.y = 180 + Math.cos(frames/15) * 10; return; }
        if (isDead) return;
        this.speed += this.gravity; this.y += this.speed;
        if (this.y + this.h >= gameHeight || this.y <= 0) { gameOver(); }
    },
    flap: function() { this.speed = -this.jump; }
};

const pipes = {
    position: [], w: 50, h: 400, gap: 140, dx: 3.5, 
    draw: function() {
        ctx.save(); ctx.shadowColor = "#28ff28"; ctx.shadowBlur = 15; ctx.lineWidth = 3; ctx.strokeStyle = "#28ff28";
        for(let p of this.position){
            let topY = Math.floor(p.y), bottomY = Math.floor(p.y + this.h + p.currentGap), pipeX = Math.floor(p.x);
            ctx.strokeRect(pipeX, topY, this.w, this.h); ctx.strokeRect(pipeX, bottomY, this.w, this.h);
        }
        ctx.restore();
    },
    update: function() {
        if(!gamePlaying) return;
        if(frames % 90 == 0){
            let minY, maxY;
            if (score < 60) { minY = -240; maxY = -200; } else { minY = -280; maxY = -160; }
            this.position.push({ x: gameWidth, y: Math.floor(Math.random() * (maxY - minY + 1) + minY), currentGap: this.gap, scored: false });
        }
        for(let i = 0; i < this.position.length; i++){
            let p = this.position[i]; p.x -= this.dx;
            if( bird.x + 12 < p.x + this.w && bird.x + bird.w - 12 > p.x && (bird.y + 12 < p.y + this.h || bird.y + bird.h - 12 > p.y + this.h + p.currentGap)){
                gameOver(); return; 
            }
            if(p.x + this.w <= 0){ this.position.shift(); i--; } 
            else if (p.x + this.w < bird.x && !p.scored) {
                p.scored = true; score++;
                if (score === 47) { sound47.play().catch(() => {}); if (!bird2Unlocked) { bird2Unlocked = true; localStorage.setItem("bird2Unlocked", "true"); justUnlockedBird2 = true; } }
                if (score % 10 === 0) { if (score <= 40) { this.dx += 0.8; } if (score >= 60 && this.gap > 115) { this.gap -= 5; } }
            }
        }
    }
};

function updateAudioData() {
    if (isAudioInitialized && !music.paused && !isMuted) {
        analyser.getByteFrequencyData(dataArray);
        let sum = 0; for(let i = 0; i < 8; i++) { sum += dataArray[i]; }
        bassPulse = sum / 8; 
    } else { bassPulse = 0; }
}

function draw(){
    ctx.imageSmoothingEnabled = false; updateAudioData(); 

    if (score >= 47 && hueShift < 160) { hueShift += 1.5; cvs.style.filter = `hue-rotate(${Math.floor(hueShift)}deg)`; }

    // --- UPDATED REACTIVE BACKGROUND ---
    if (bgImg.complete) {
        let baseScale = Math.max(gameWidth / bgImg.width, gameHeight / bgImg.height);
        let beat = (bassPulse > 130) ? ((bassPulse - 130) / 125) : 0;
        
        // Pumping scale logic
        let reactiveScale = baseScale * (1 + beat * 0.05); 
        let x = (gameWidth / 2) - (bgImg.width / 2) * reactiveScale; 
        let y = (gameHeight) - (bgImg.height * reactiveScale) + (beat * 10); 
        
        ctx.save();
        ctx.drawImage(bgImg, Math.floor(x), Math.floor(y), Math.floor(bgImg.width * reactiveScale), Math.floor(bgImg.height * reactiveScale));
        
        // Additive Bloom Logic
        if (beat > 0) {
            ctx.globalCompositeOperation = "lighter";
            ctx.globalAlpha = beat * 0.8; 
            ctx.shadowColor = "#28ff28";
            ctx.shadowBlur = beat * 40 + 10;
            ctx.drawImage(bgImg, Math.floor(x), Math.floor(y), Math.floor(bgImg.width * reactiveScale), Math.floor(bgImg.height * reactiveScale));
        }
        ctx.restore();
    } else { ctx.fillStyle = "#000"; ctx.fillRect(0, 0, gameWidth, gameHeight); }
    
    starfield.draw(); pipes.draw(); bird.draw();

    if (isViewingUI || !username) return;

    if (gamePlaying) { ctx.fillStyle = "#28ff28"; ctx.font = "bold 45px Courier New"; ctx.textAlign = "center"; ctx.fillText(score, gameWidth/2, 80); }

    if(!gamePlaying && !isDead){
        ctx.fillStyle = "rgba(40, 255, 40, 0.7)"; ctx.font = "bold 16px Courier New"; ctx.textAlign = "center"; 
        ctx.fillText("[ MENU ]", gameWidth/2, 50);
        
        ctx.fillStyle = "rgba(40, 255, 40, 0.9)"; ctx.font = "bold 24px Courier New"; ctx.fillText("INITIATE SEQUENCE", gameWidth/2, gameHeight/2 + 20);
        ctx.fillStyle = "#fff"; ctx.font = "bold 12px Courier New"; ctx.fillText("USER: " + username, gameWidth/2, gameHeight/2 + 50);
    }

    if(isDead){
        ctx.fillStyle = "rgba(0, 0, 0, 0.7)"; ctx.fillRect(0, 0, gameWidth, gameHeight);
        ctx.fillStyle = "#28ff28"; ctx.font = "bold 24px Courier New"; ctx.textAlign = "center"; ctx.fillText("SEQUENCE TERMINATED", gameWidth/2, gameHeight/2 - 80);
        ctx.fillStyle = "#FFF"; ctx.font = "bold 50px Courier New"; ctx.fillText("SCORE: " + finalScore, gameWidth/2, gameHeight/2 - 20);
        
        if (justUnlockedBird2) {
            ctx.fillStyle = "rgba(40, 255, 40, 0.9)"; ctx.font = "bold 16px Courier New"; ctx.fillText("NEW VESSEL UNLOCKED", gameWidth/2, gameHeight/2 + 20);
            if (bird2Img.complete) ctx.drawImage(bird2Img, gameWidth/2 - 20, gameHeight/2 + 35, 40, 50);
        } else if (finalScore >= highScore && finalScore > 0) {
            ctx.fillStyle = "#28ff28"; ctx.font = "bold 14px Courier New"; ctx.fillText("NEW HIGH SCORE DETECTED", gameWidth/2, gameHeight/2 + 20);
        }

        ctx.fillStyle = "rgba(40, 255, 40, 0.8)"; ctx.font = "bold 16px Courier New"; ctx.fillText("TAP TO RE-INITIATE", gameWidth/2, gameHeight/2 + 105);

        ctx.fillStyle = "rgba(40, 255, 40, 0.1)"; ctx.fillRect(gameWidth/2 - 70, gameHeight/2 + 130, 140, 35);
        ctx.strokeStyle = "#28ff28"; ctx.lineWidth = 2; ctx.strokeRect(gameWidth/2 - 70, gameHeight/2 + 130, 140, 35);
        ctx.fillStyle = "#28ff28"; ctx.font = "bold 16px Courier New"; ctx.fillText("SHARE SCORE", gameWidth/2, gameHeight/2 + 152);
    }
}

function loop(){ starfield.update(); bird.update(); pipes.update(); draw(); frames++; requestAnimationFrame(loop); }

function gameOver(){
    gamePlaying = false; isDead = true; finalScore = score;
    if(score > highScore) { highScore = score; localStorage.setItem("starseedHighScore", highScore); }
    pushScoreToCloud();

    music.pause(); music.currentTime = 0;
    currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
    music.src = playlist[currentTrackIndex];
}

function handleAction(e) {
    if (isViewingUI || !username || e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
    if (e && e.type === "touchstart") e.preventDefault();
    if (!isAudioInitialized) { initAudio(); }
    if (audioCtx && audioCtx.state === 'suspended') { audioCtx.resume(); }

    let touchX, touchY;
    if (e && (e.type === "touchstart" || e.type === "mousedown")) {
        const rect = cvs.getBoundingClientRect();
        if (e.type === "touchstart") { touchX = (e.touches[0].clientX - rect.left) * (gameWidth / rect.width); touchY = (e.touches[0].clientY - rect.top) * (gameHeight / rect.height); } 
        else { touchX = (e.clientX - rect.left) * (gameWidth / rect.width); touchY = (e.clientY - rect.top) * (gameHeight / rect.height); }
    }

    if (!gamePlaying && !isDead && touchY && touchY < 70 && touchX > gameWidth/2 - 50 && touchX < gameWidth/2 + 50) {
        openMainMenu(); return;
    }
    
    if(isDead) {
        if (touchX && touchY && touchX > gameWidth/2 - 70 && touchX < gameWidth/2 + 70 && touchY > gameHeight/2 + 130 && touchY < gameHeight/2 + 165) {
            if (navigator.share) { navigator.share({ title: 'STARSEED SEQUENCE', text: `[${username}] survived ${finalScore} cycles. Beat my record.`, url: window.location.href }).catch(console.error); } 
            else { alert(`You scored ${finalScore}! Copy this page link and dare the crew.`); }
            return; 
        }

        justUnlockedBird2 = false; isDead = false; bird.y = 180; bird.speed = 0; pipes.position = [];
        pipes.dx = 3.5; pipes.gap = 140; score = 0; frames = 0; hueShift = 0; cvs.style.filter = `hue-rotate(0deg)`;
        return;
    }
    
    if(!gamePlaying){ gamePlaying = true; music.play().catch(() => {}); }
    bird.flap();
}

window.addEventListener("mousedown", handleAction);
window.addEventListener("touchstart", handleAction, { passive: false }); 
window.addEventListener("keydown", (e) => { if(e.code === "Space") handleAction(); });

loop();
</script>
</body>
</html>
