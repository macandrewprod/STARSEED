<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>STARSEED - Reactive Engine</title>
    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #000; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            user-select: none; -webkit-user-select: none; touch-action: none;
        }
        #game-container {
            position: relative; width: 100vw; height: 100vh;
            max-width: 450px; max-height: 850px;
            display: flex; justify-content: center; align-items: center;
            background-color: #0d0d0d;
        }
        canvas {
            display: block; width: 100%; height: 100%;
            object-fit: contain; 
            image-rendering: -moz-pixelated;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
    </style>
</head>
<body>

<div id="game-container"></div>

<script>
const container = document.getElementById('game-container');
const cvs = document.createElement("canvas");
const ctx = cvs.getContext("2d");

const gameWidth = 280;
const gameHeight = 500;
const dpr = window.devicePixelRatio || 1;

cvs.width = gameWidth * dpr;
cvs.height = gameHeight * dpr;
ctx.scale(dpr, dpr);

ctx.imageSmoothingEnabled = false;
container.appendChild(cvs);

// --- ASSETS ---
const bird1Img = new Image(); bird1Img.src = "bird.png"; 
const bird2Img = new Image(); bird2Img.src = "bird2.png"; 
const bgImg = new Image(); bgImg.src = "bg.png"; 

// --- AUDIO & WEB AUDIO API SETUP ---
const playlist = ["music.mp3", "music2.mp3", "music3.mp3", "music4.mp3"];
let currentTrackIndex = 0;
const music = new Audio();
music.crossOrigin = "anonymous"; // Required for Web Audio API analysis
music.src = playlist[currentTrackIndex];
music.loop = true;
const sound47 = new Audio();
sound47.src = "47.mp3";

// Reactive Audio Variables
let audioCtx, analyser, source, dataArray;
let isAudioInitialized = false;
let bassPulse = 0; // Value between 0 and 255

function initAudio() {
    if (isAudioInitialized) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256; 
    
    source = audioCtx.createMediaElementSource(music);
    source.connect(analyser);
    analyser.connect(audioCtx.destination);
    
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    isAudioInitialized = true;
}

// --- VARIABLES ---
let gamePlaying = false;
let isDead = false;
let frames = 0;
let score = 0;
let finalScore = 0;
let highScore = localStorage.getItem("starseedHighScore") || 0;

let bird2Unlocked = localStorage.getItem("bird2Unlocked") === "true";
let selectedBird = 1; 
let justUnlockedBird2 = false; 

// --- STARFIELD ---
const starfield = {
    particles: [],
    init: function() {
        for(let i = 0; i < 60; i++) { 
            this.particles.push({
                x: Math.random() * gameWidth,
                y: Math.random() * gameHeight,
                size: Math.random() * 0.9 + 0.4, 
                speed: Math.random() * 0.8 + 0.1,
                opacity: Math.random() 
            });
        }
    },
    draw: function() {
        for(let i = 0; i < this.particles.length; i++) {
            let p = this.particles[i];
            p.opacity += (Math.random() - 0.5) * 0.1;
            if(p.opacity < 0.2) p.opacity = 0.2;
            if(p.opacity > 1) p.opacity = 1;
            ctx.fillStyle = (i % 6 === 0) ? `rgba(40, 255, 40, ${p.opacity})` : `rgba(255, 255, 255, ${p.opacity})`;
            ctx.fillRect(Math.floor(p.x), Math.floor(p.y), p.size, p.size);
        }
    },
    update: function() {
        // Speed boosts slightly when the bass hits
        let reactiveSpeed = (bassPulse / 255) * 1.5;
        let globalSpeed = (gamePlaying || isDead) ? (2.5 + reactiveSpeed) : 0.3; 
        
        for(let p of this.particles) {
            p.x -= (p.speed * globalSpeed);
            if(p.x < 0) { p.x = gameWidth; p.y = Math.random() * gameHeight; }
        }
    }
};
starfield.init();

// --- VESSEL ---
const bird = {
    x: 50, y: 220, w: 55, h: 65, speed: 0, gravity: 0.32, jump: 5.8,    
    draw: function() {
        let currentImg = (selectedBird === 1) ? bird1Img : bird2Img;
        if (currentImg.complete) { 
            ctx.drawImage(currentImg, Math.floor(this.x), Math.floor(this.y), this.w, this.h); 
        }
    },
    update: function() {
        if (!gamePlaying && !isDead) { this.y = 220 + Math.cos(frames/15) * 10; return; }
        if (isDead) return;
        this.speed += this.gravity;
        this.y += this.speed;
        if (this.y + this.h >= gameHeight || this.y <= 0) { gameOver(); }
    },
    flap: function() { this.speed = -this.jump; }
};

// --- PILLARS ---
const pipes = {
    position: [], w: 50, h: 400, gap: 140, dx: 3.5, 
    draw: function() {
        ctx.save();
        
        // REACTIVE GLOW: The blur intensifies based on the bass frequency
        let dynamicBlur = 10 + (bassPulse * 0.15); 
        ctx.shadowColor = "#28ff28"; 
        ctx.shadowBlur = dynamicBlur;
        
        // Slightly thicken the line on heavy beats
        ctx.lineWidth = 3 + (bassPulse / 150);
        ctx.strokeStyle = "#28ff28";

        for(let p of this.position){
            let topY = Math.floor(p.y);
            let bottomY = Math.floor(p.y + this.h + p.currentGap);
            let pipeX = Math.floor(p.x);

            ctx.strokeRect(pipeX, topY, this.w, this.h);
            ctx.strokeRect(pipeX, bottomY, this.w, this.h);
        }
        ctx.restore();
    },
    update: function() {
        if(!gamePlaying) return;
        
        if(frames % 90 == 0){
            let minY, maxY;
            if (score < 47) {
                minY = -240; maxY = -200; 
            } else {
                minY = -320; maxY = -120; 
            }
            let randomY = Math.floor(Math.random() * (maxY - minY + 1) + minY);
            this.position.push({ x: gameWidth, y: randomY, currentGap: this.gap, scored: false });
        }
        
        for(let i = 0; i < this.position.length; i++){
            let p = this.position[i];
            p.x -= this.dx;
            
            if( bird.x + 12 < p.x + this.w && bird.x + bird.w - 12 > p.x && 
               (bird.y + 12 < p.y + this.h || bird.y + bird.h - 12 > p.y + this.h + p.currentGap)){
                gameOver(); return; 
            }
            
            if(p.x + this.w <= 0){ this.position.shift(); i--; } 
            else if (p.x + this.w < bird.x && !p.scored) {
                p.scored = true;
                score++;
                if (score === 47) {
                    sound47.play().catch(() => {});
                    if (!bird2Unlocked) {
                        bird2Unlocked = true;
                        localStorage.setItem("bird2Unlocked", "true");
                        justUnlockedBird2 = true; 
                    }
                }
                if (score % 10 === 0) { 
                    this.dx += 0.8; 
                    if (score >= 47 && this.gap > 115) { this.gap -= 5; }
                }
            }
        }
    }
};

// --- ENGINE ---
function updateAudioData() {
    if (isAudioInitialized && !music.paused) {
        analyser.getByteFrequencyData(dataArray);
        // Isolate the lowest frequencies (bass)
        let sum = 0;
        for(let i = 0; i < 8; i++) { sum += dataArray[i]; }
        bassPulse = sum / 8; 
    } else {
        bassPulse = 0;
    }
}

function draw(){
    ctx.imageSmoothingEnabled = false;
    updateAudioData(); // Process the audio frequency every frame

    if (bgImg.complete) {
        let scale = Math.max(gameWidth / bgImg.width, gameHeight / bgImg.height);
        let x = (gameWidth / 2) - (bgImg.width / 2) * scale;
        let y = (gameHeight) - (bgImg.height * scale); 
        ctx.drawImage(bgImg, Math.floor(x), Math.floor(y), Math.floor(bgImg.width * scale), Math.floor(bgImg.height * scale));
    } else {
        ctx.fillStyle = "#000"; ctx.fillRect(0, 0, gameWidth, gameHeight);
    }
    
    // REACTIVE BACKGROUND FLASH: Subtly light up the screen on heavy kicks
    if (bassPulse > 180 && gamePlaying) {
        ctx.fillStyle = `rgba(40, 255, 40, ${(bassPulse - 180) / 75 * 0.15})`;
        ctx.fillRect(0, 0, gameWidth, gameHeight);
    }

    starfield.draw(); pipes.draw(); bird.draw();

    if (gamePlaying) {
        ctx.fillStyle = "#28ff28"; ctx.font = "bold 45px Courier New";
        ctx.textAlign = "center"; ctx.fillText(score, gameWidth/2, 80);
    }

    if(!gamePlaying && !isDead){
        ctx.fillStyle = "rgba(255, 255, 255, 0.5)"; ctx.font = "bold 14px Courier New";
        ctx.textAlign = "center"; ctx.fillText("HIGH SCORE: " + highScore, gameWidth/2, 40);
        ctx.fillStyle = "#FFF"; ctx.font = "bold 12px Courier New"; ctx.fillText("SELECT VESSEL", gameWidth/2, 65);
        
        ctx.strokeStyle = (selectedBird === 1) ? "#28ff28" : "#444";
        ctx.strokeRect(gameWidth/2 - 55, 80, 50, 60);
        if (bird1Img.complete) ctx.drawImage(bird1Img, gameWidth/2 - 50, 90, 40, 45);
        
        if (bird2Unlocked) {
            ctx.strokeStyle = (selectedBird === 2) ? "#28ff28" : "#444";
            ctx.strokeRect(gameWidth/2 + 5, 80, 50, 60);
            if (bird2Img.complete) ctx.drawImage(bird2Img, gameWidth/2 + 10, 90, 40, 45);
        } else {
            ctx.fillStyle = "#333"; ctx.fillRect(gameWidth/2 + 5, 80, 50, 60);
            ctx.fillStyle = "#666"; ctx.font = "bold 10px Courier New"; ctx.fillText("LOCKED", gameWidth/2 + 30, 115);
        }

        ctx.fillStyle = "rgba(40, 255, 40, 0.9)"; ctx.font = "bold 24px Courier New";
        ctx.fillText("INITIATE SEQUENCE", gameWidth/2, gameHeight/2 + 50);
    }

    if(isDead){
        ctx.fillStyle = "rgba(0, 0, 0, 0.7)"; ctx.fillRect(0, 0, gameWidth, gameHeight);
        
        ctx.fillStyle = "#28ff28"; ctx.font = "bold 24px Courier New";
        ctx.textAlign = "center"; ctx.fillText("SEQUENCE TERMINATED", gameWidth/2, gameHeight/2 - 60);
        
        ctx.fillStyle = "#FFF"; ctx.font = "bold 50px Courier New";
        ctx.fillText("SCORE: " + finalScore, gameWidth/2, gameHeight/2);
        
        if (justUnlockedBird2) {
            ctx.fillStyle = "rgba(40, 255, 40, 0.9)";
            ctx.font = "bold 16px Courier New";
            ctx.fillText("NEW VESSEL UNLOCKED", gameWidth/2, gameHeight/2 + 40);
            if (bird2Img.complete) ctx.drawImage(bird2Img, gameWidth/2 - 20, gameHeight/2 + 55, 40, 50);
        } 
        else if (finalScore >= highScore && finalScore > 0) {
            ctx.fillStyle = "#28ff28";
            ctx.font = "bold 14px Courier New";
            ctx.fillText("NEW HIGH SCORE DETECTED", gameWidth/2, gameHeight/2 + 40);
        }

        ctx.fillStyle = "rgba(40, 255, 40, 0.8)"; ctx.font = "bold 18px Courier New";
        ctx.fillText("TAP TO RE-INITIATE", gameWidth/2, gameHeight/2 + 120);
    }
}

function loop(){ starfield.update(); bird.update(); pipes.update(); draw(); frames++; requestAnimationFrame(loop); }

function gameOver(){
    gamePlaying = false; isDead = true; finalScore = score;
    if(score > highScore) { highScore = score; localStorage.setItem("starseedHighScore", highScore); }
    music.pause(); music.currentTime = 0;
    currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
    music.src = playlist[currentTrackIndex];
}

function handleAction(e) {
    if (e && e.type === "touchstart") e.preventDefault();
    
    // Initialize Web Audio API on first user interaction to bypass browser blocks
    if (!isAudioInitialized) {
        initAudio();
    }
    if (audioCtx && audioCtx.state === 'suspended') {
        audioCtx.resume();
    }

    if (!gamePlaying && !isDead) {
        let touchX, touchY;
        const rect = cvs.getBoundingClientRect();
        if (e.type === "touchstart") {
            touchX = (e.touches[0].clientX - rect.left) * (gameWidth / rect.width);
            touchY = (e.touches[0].clientY - rect.top) * (gameHeight / rect.height);
        } else {
            touchX = (e.clientX - rect.left) * (gameWidth / rect.width);
            touchY = (e.clientY - rect.top) * (gameHeight / rect.height);
        }
        if (touchX > gameWidth/2 - 55 && touchX < gameWidth/2 - 5 && touchY > 80 && touchY < 140) { selectedBird = 1; return; }
        if (bird2Unlocked && touchX > gameWidth/2 + 5 && touchX < gameWidth/2 + 55 && touchY > 80 && touchY < 140) { selectedBird = 2; return; }
    }
    if(isDead) {
        justUnlockedBird2 = false; 
        isDead = false; bird.y = 220; bird.speed = 0; pipes.position = [];
        pipes.dx = 3.5; pipes.gap = 140; score = 0; frames = 0; return;
    }
    if(!gamePlaying){ gamePlaying = true; music.play().catch(() => {}); }
    bird.flap();
}

window.addEventListener("mousedown", handleAction);
window.addEventListener("touchstart", handleAction, { passive: false }); 
window.addEventListener("keydown", (e) => { if(e.code === "Space") handleAction(); });

loop();
</script>
</body>
</html>
